{% extends "layout_admin.html" %}
{% load static %}

{% block title %}Öğrenci Detayı | {{ ogrenci.ad_soyad }} | Şeyma{% endblock %}

{% block css_file %}
<link rel="stylesheet" href="{% static 'mainproject/css/admin.css' %}">
<style>
    .profile-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .profile-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .profile-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #e9ecef;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: #f8f9fc;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #4e73df;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #4e73df;
        margin-bottom: 5px;
    }
    
    .tab-container {
        margin-bottom: 20px;
    }
    
    .tab-buttons {
        display: flex;
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .tab-button {
        padding: 12px 20px;
        background: none;
        border: none;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        border-bottom: 3px solid transparent;
    }
    
    .tab-button.active {
        color: #4e73df;
        border-bottom-color: #4e73df;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .data-table th, 
    .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e3e6f0;
    }
    
    .data-table th {
        background-color: #f8f9fc;
        font-weight: 600;
    }
    
    .chart-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card2 {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 400px;
    }
    
    .chart-card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 380px;
    }
    
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .comparison-table th,
    .comparison-table td {
        padding: 12px;
        border: 1px solid #e3e6f0;
    }
    
    .comparison-table th {
        background-color: #f8f9fc;
        font-weight: 600;
    }
    
    .current-student {
        background-color: rgba(78, 115, 223, 0.05) !important;
        font-weight: 600;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary {
        background: #4e73df;
        color: white;
    }
    
    .btn-success {
        background: #1cc88a;
        color: white;
    }
    
    .btn-danger {
        background: #e74a3b;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .analiz-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .analiz-grid-2 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .analiz-card {
        background: white;
        border-radius: 8px;
        padding: 35px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 320px;
    }
    
    .gelisim-card {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 320px;
    }
    
    @media (max-width: 768px) {
        .chart-container {
            grid-template-columns: 1fr;
        }
        
        .analiz-grid {
            grid-template-columns: 1fr;
        }
        
        .analiz-grid-2 {
            grid-template-columns: 1fr;
        }
        
        .tab-buttons {
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .profile-header {
            flex-direction: column;
            text-align: center;
        }
        
        .chart-card2, .chart-card {
            padding: 20px;
            height: 350px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Sayfa Başlığı -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-user-graduate text-primary mr-2"></i>Öğrenci Detayı
        </h1>
        <a href="{% url 'ogrenci_listesi' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i> Öğrenci Listesine Dön
        </a>
    </div>
    
    <!-- Öğrenci Profil Bilgileri -->
    <div class="profile-container">
        <div class="profile-header">
            {% if ogrenci.profil_foto %}
            <img src="{{ ogrenci.profil_foto.url }}" alt="{{ ogrenci.ad_soyad }}" class="profile-image">
            {% else %}
            <div class="profile-image d-flex align-items-center justify-content-center bg-light">
                <i class="fas fa-user fa-2x text-secondary"></i>
            </div>
            {% endif %}
            
            <div>
                <h2 class="mb-1">{{ ogrenci.ad_soyad }}</h2>
                <div class="d-flex flex-wrap gap-2 mb-2">
                    <span class="badge bg-primary">{{ ogrenci.get_seviye_display }}</span>
                    <span class="badge bg-info">Kayıt: {{ ogrenci.kayit_tarihi|date:"d.m.Y" }}</span>
                    <span class="badge bg-success">Sıra: {{ sinif_siralamasi }}/{{ toplam_ogrenci_sayisi }}</span>
                </div>
                {% if ogrenci.ozel_notlar %}
                <p class="mb-0"><strong>Özel Notlar:</strong> {{ ogrenci.ozel_notlar }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- İstatistik Kartları -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ sinav_ortalamasi|floatformat:1 }}</div>
                <div class="stat-label">Sınav Ortalaması</div>
                <small>Sınıf: {{ sinif_ortalamasi|floatformat:1 }}</small>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ tamamlanan_ezberler }}</div>
                <div class="stat-label">Tamamlanan Ezber</div>
                <small>Toplam: {{ toplam_ezber }}</small>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{ tamamlanan_elifba }}</div>
                <div class="stat-label">Tamamlanan Elif Ba</div>
                <small>Toplam: {{ toplam_elifba }}</small>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{% if ortalama_ezber_suresi %}{{ ortalama_ezber_suresi|floatformat:1 }}{% else %}0{% endif %}</div>
                <div class="stat-label">Ort. Ezber Süresi</div>
                <small>Tahmini: 7 gün</small>
            </div>
        </div>
    </div>
    
    <!-- Yapay Zeka Analizi -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-robot mr-2"></i>Gemini AI Öğrenci Analizi
            </h6>
        </div>
        <div class="card-body">
            {% if ai_analizi %}
                <div class="ai-content">{{ ai_analizi|safe }}</div>
                <div class="text-center mt-3">
                    <a href="?ai_analiz=0" class="btn btn-secondary">
                        <i class="fas fa-times mr-2"></i>AI Analizini Gizle
                    </a>
                </div>
            {% else %}
                {% if request.GET.ai_analiz == '1' %}
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3"></div>
                        <p>AI analiz yapıyor, lütfen bekleyin...</p>
                        <p class="text-muted">Bu işlem birkaç saniye sürebilir</p>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <p>AI analizini görmek için butona tıklayın.</p>
                        <a href="?ai_analiz=1" class="btn btn-primary" id="ai-analiz-btn">
                            <i class="fas fa-robot mr-2"></i>AI Analizini Göster
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Tab İçeriği -->
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="sinavlar">Sınav Sonuçları</button>
            <button class="tab-button" data-tab="ezberler">Ezber Durumu</button>
            <button class="tab-button" data-tab="elifba">Elif Ba Durumu</button>
            <button class="tab-button" data-tab="analiz">Detaylı Analiz</button>
            <button class="tab-button" data-tab="karsilastirma">Karşılaştırmalar</button>
        </div>
        
        <!-- Sınav Sonuçları Tab -->
        <div class="tab-content active" id="sinavlar-tab">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-book mr-2"></i>Ders Bazlı Puanlar
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for ders, ortalama in ders_bazli_ortalama.items %}
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card border-left-primary h-100">
                                <div class="card-body text-center">
                                    <h5 class="card-title text-primary">{{ ders }}</h5>
                                    <h2 class="text-gray-800">{{ ortalama|floatformat:1 }}</h2>
                                    <span class="badge 
                                        {% if ortalama >= 85 %}bg-success
                                        {% elif ortalama >= 70 %}bg-info
                                        {% elif ortalama >= 50 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {% if ortalama >= 85 %}Çok İyi
                                        {% elif ortalama >= 70 %}İyi
                                        {% elif ortalama >= 50 %}Orta
                                        {% else %}Zayıf{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-file-alt mr-2"></i>Detaylı Sınav Sonuçları
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ders</th>
                                    <th>Sınav Tipi</th>
                                    <th>Puan</th>
                                    <th>Tarih</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sinav in sinav_sonuclari %}
                                <tr>
                                    <td>{{ sinav.ders.get_tur_display }}</td>
                                    <td>{{ sinav.get_sinav_tipi_display }}</td>
                                    <td>{{ sinav.puan }}</td>
                                    <td>{{ sinav.tarih|date:"d.m.Y" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if sinav.puan >= 85 %}bg-success
                                            {% elif sinav.puan >= 70 %}bg-info
                                            {% elif sinav.puan >= 50 %}bg-warning
                                            {% else %}bg-danger{% endif %}">
                                            {% if sinav.puan >= 85 %}Çok İyi
                                            {% elif sinav.puan >= 70 %}İyi
                                            {% elif sinav.puan >= 50 %}Orta
                                            {% else %}Zayıf{% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4">Henüz sınav sonucu bulunmamaktadır.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ezber Durumu Tab -->
        <div class="tab-content" id="ezberler-tab">
            <div class="row">
                {% for ezber in ezber_kayitlari %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 {% if ezber.durum == 'TAMAMLANDI' %}border-success{% elif ezber.durum == 'DEVAM' %}border-info{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">{{ ezber.sure.ad }} ({{ ezber.sure.sira }})</h5>
                                {% if ezber.durum == 'TAMAMLANDI' %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <span class="badge 
                                    {% if ezber.durum == 'TAMAMLANDI' %}bg-success
                                    {% elif ezber.durum == 'DEVAM' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {% if ezber.durum == 'TAMAMLANDI' %}Tamamlandı
                                    {% elif ezber.durum == 'DEVAM' %}Devam Ediyor
                                    {% else %}Başlamadı{% endif %}
                                </span>
                            </div>
                            
                            <div class="progress mb-2">
                                <div class="progress-bar 
                                    {% if ezber.durum == 'TAMAMLANDI' %}bg-success
                                    {% elif ezber.durum == 'DEVAM' %}bg-info
                                    {% else %}bg-secondary{% endif %}" 
                                    role="progressbar" 
                                    style="width: {% if ezber.durum == 'TAMAMLANDI' %}100{% elif ezber.durum == 'DEVAM' %}{{ ezber.ilerleme|default:50 }}{% else %}0{% endif %}%" 
                                    aria-valuenow="{% if ezber.durum == 'TAMAMLANDI' %}100{% elif ezber.durum == 'DEVAM' %}{{ ezber.ilerleme|default:50 }}{% else %}0{% endif %}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mb-3">
                                <span>0%</span>
                                <span>{% if ezber.durum == 'TAMAMLANDI' %}100%{% elif ezber.durum == 'DEVAM' %}{{ ezber.ilerleme|default:50 }}%{% else %}0%{% endif %}</span>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Başlama</small>
                                    <p class="mb-0">{% if ezber.baslama_tarihi %}{{ ezber.baslama_tarihi|date:"d.m.Y" }}{% else %}-{% endif %}</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Bitiş</small>
                                    <p class="mb-0">{% if ezber.bitis_tarihi %}{{ ezber.bitis_tarihi|date:"d.m.Y" }}{% else %}-{% endif %}</p>
                                </div>
                            </div>
                            
                            {% if ezber.yorum %}
                            <div class="mt-3">
                                <small class="text-muted">Yorum</small>
                                <p class="mb-0">{{ ezber.yorum }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-4">
                    Henüz ezber kaydı bulunmamaktadır.
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Elif Ba Durumu Tab -->
        <div class="tab-content" id="elifba-tab">
            <div class="row">
                {% for elifba in elifba_durumlari %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100 {% if elifba.durum == 'TAMAMLANDI' %}border-success{% elif elifba.durum == 'DEVAM' %}border-info{% endif %}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">{{ elifba.ezber.ad }}</h5>
                                {% if elifba.durum == 'TAMAMLANDI' %}
                                <i class="fas fa-check-circle text-success"></i>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <span class="badge 
                                    {% if elifba.durum == 'TAMAMLANDI' %}bg-success
                                    {% elif elifba.durum == 'DEVAM' %}bg-info
                                    {% else %}bg-secondary{% endif %}">
                                    {% if elifba.durum == 'TAMAMLANDI' %}Tamamlandı
                                    {% elif elifba.durum == 'DEVAM' %}Devam Ediyor
                                    {% else %}Başlamadı{% endif %}
                                </span>
                            </div>
                            
                            <div class="progress mb-2">
                                <div class="progress-bar 
                                    {% if elifba.durum == 'TAMAMLANDI' %}bg-success
                                    {% elif elifba.durum == 'DEVAM' %}bg-info
                                    {% else %}bg-secondary{% endif %}" 
                                    role="progressbar" 
                                    style="width: {% if elifba.durum == 'TAMAMLANDI' %}100{% elif elifba.durum == 'DEVAM' %}{{ elifba.ilerleme|default:50 }}{% else %}0{% endif %}%" 
                                    aria-valuenow="{% if elifba.durum == 'TAMAMLANDI' %}100{% elif elifba.durum == 'DEVAM' %}{{ elifba.ilerleme|default:50 }}{% else %}0{% endif %}" 
                                    aria-valuemin="0" 
                                    aria-valuemax="100">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mb-3">
                                <span>0%</span>
                                <span>{% if elifba.durum == 'TAMAMLANDI' %}100%{% elif elifba.durum == 'DEVAM' %}{{ elifba.ilerleme|default:50 }}%{% else %}0%{% endif %}</span>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Başlama</small>
                                    <p class="mb-0">{% if elifba.baslama_tarihi %}{{ elifba.baslama_tarihi|date:"d.m.Y" }}{% else %}-{% endif %}</p>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Bitiş</small>
                                    <p class="mb-0">{% if elifba.bitis_tarihi %}{{ elifba.bitis_tarihi|date:"d.m.Y" }}{% else %}-{% endif %}</p>
                                </div>
                            </div>
                            
                            {% if elifba.yorum %}
                            <div class="mt-3">
                                <small class="text-muted">Yorum</small>
                                <p class="mb-0">{{ elifba.yorum }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-4">
                    Henüz Elif Ba ezber kaydı bulunmamaktadır.
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Analiz Tab -->
        <div class="tab-content" id="analiz-tab">
            <!-- Pasta Grafikler -->
            <div class="analiz-grid">
                <div class="analiz-card">
                    <h5 class="chart-title"><i class="fas fa-chart-pie mr-2"></i>Ezber Durumu</h5>
                    <canvas id="ezberDurumChart"></canvas>
                </div>
                
                <div class="analiz-card">
                    <h5 class="chart-title"><i class="fas fa-chart-pie mr-2"></i>Elif Ba Durumu</h5>
                    <canvas id="elifbaDurumChart"></canvas>
                </div>
                
                <div class="analiz-card">
                    <h5 class="chart-title"><i class="fas fa-chart-bar mr-2"></i>Tüm Sınav Puanları</h5>
                    <canvas id="tumSinavPuanlariChart"></canvas>
                </div>
            </div>
            
            
            <!-- İstatistik Kartları -->
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-calendar-day fa-2x text-primary mb-2"></i>
                            <h4>{{ kayit_suresi_gun }} gün</h4>
                            <p class="text-muted">Kayıt Süresi</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h4>%{{ tamamlanan_ezber_yuzde|floatformat:1 }}</h4>
                            <p class="text-muted">Ezber Tamamlama</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-book fa-2x text-info mb-2"></i>
                            <h4>%{{ tamamlanan_elifba_yuzde|floatformat:1 }}</h4>
                            <p class="text-muted">Elif Ba Tamamlama</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-trophy fa-2x text-warning mb-2"></i>
                            <h4>{{ sinif_siralamasi }}/{{ toplam_ogrenci_sayisi }}</h4>
                            <p class="text-muted">Sınıf Sıralaması</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sınav İstatistikleri -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar mr-2"></i>Sınav İstatistikleri
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="comparison-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>İstatistik</th>
                                    <th>Öğrenci</th>
                                    <th>Sınıf Ortalaması</th>
                                    <th>Fark</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Genel Ortalama</td>
                                    <td><strong>{{ sinav_ortalamasi|floatformat:1 }}</strong></td>
                                    <td>{{ sinif_ortalamasi|floatformat:1 }}</td>
                                    <td class="{% if sinav_ortalamasi > sinif_ortalamasi %}text-success{% elif sinav_ortalamasi < sinif_ortalamasi %}text-danger{% else %}text-muted{% endif %}">
                                        {% if sinav_ortalamasi > sinif_ortalamasi %}+{% endif %}{{ sinav_ortalamasi|floatformat:1|add:sinif_ortalamasi|floatformat:1 }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Toplam Sınav Sayısı</td>
                                    <td><strong>{{ sinav_sonuclari.count }}</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>En Yüksek Puan</td>
                                    <td><strong>{{ max_puan|default:0|floatformat:1 }}</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>En Düşük Puan</td>
                                    <td><strong>{{ min_puan|default:0|floatformat:1 }}</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Karşılaştırmalar Tab -->
        <div class="tab-content" id="karsilastirma-tab">
            <div class="chart-container">
                <div class="chart-card">
                    <h5 class="chart-title"><i class="fas fa-chart-bar mr-2"></i>Ezber Performansı Karşılaştırması</h5>
                    <canvas id="ezberKarsilastirmaChart"></canvas>
                </div>
                
                <div class="chart-card">
                    <h5 class="chart-title"><i class="fas fa-chart-bar mr-2"></i>Elif Ba Performansı Karşılaştırması</h5>
                    <canvas id="elifbaKarsilastirmaChart"></canvas>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-list mr-2"></i>Öğrenci Performans Karşılaştırması
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="comparison-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Sıra</th>
                                    <th>Öğrenci</th>
                                    <th>Sınav Ort.</th>
                                    <th>Tamam. Ezber</th>
                                    <th>Tamam. Elif Ba</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in tum_ogrenci_verileri %}
                                <tr class="{% if o.id == ogrenci.id %}current-student{% endif %}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        {% if o.id == ogrenci.id %}
                                        <strong>{{ o.ad_soyad }}</strong>
                                        {% else %}
                                        {{ o.ad_soyad }}
                                        {% endif %}
                                    </td>
                                    <td>{{ o.ortalama|floatformat:1 }}</td>
                                    <td>{{ o.tamamlanan_ezber }}</td>
                                    <td>{{ o.tamamlanan_elifba }}</td>
                                    <td>
                                        {% if o.id == ogrenci.id %}
                                        <span class="badge bg-success">Mevcut</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Diğer</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- İşlem Butonları -->
    <div class="action-buttons">
        <a href="{% url 'ogrenci_duzenle' ogrenci.id %}" class="btn btn-primary">
            <i class="fas fa-edit mr-2"></i> Öğrenciyi Düzenle
        </a>
        <a href="{% url 'export_ogrenci_detay_excel' ogrenci.id %}" class="btn btn-success">
            <i class="fas fa-file-excel mr-2"></i> Excel'e Aktar
        </a>
        <a href="{% url 'ogrenci_sil' ogrenci.id %}" class="btn btn-danger" onclick="return confirm('Bu öğrenciyi silmek istediğinize emin misiniz?');">
            <i class="fas fa-trash mr-2"></i> Öğrenciyi Sil
        </a>
    </div>
</div>

<!-- Chart.js -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartInstances = {};
    
    // Tab işlevselliği
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            if (tabId === 'analiz' || tabId === 'karsilastirma') {
                initCharts();
            }
        });
    });
    
    // AI analiz butonu
    const aiAnalizBtn = document.getElementById('ai-analiz-btn');
    if (aiAnalizBtn) {
        aiAnalizBtn.addEventListener('click', function(e) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Yükleniyor...';
            this.classList.add('disabled');
        });
    }
    
    function destroyCharts() {
        Object.values(chartInstances).forEach(chart => {
            if (chart) chart.destroy();
        });
    }
    
    function initCharts() {
        destroyCharts();
        
        // 1. Ezber durumu grafiği - ESKİ KODDAKİ GİBİ YAPILDI
        const ezberDurumCtx = document.getElementById('ezberDurumChart')?.getContext('2d');
        if (ezberDurumCtx) {
            chartInstances.ezberDurum = new Chart(ezberDurumCtx, {
                type: 'pie',
                data: {
                    labels: ['Tamamlanan', 'Devam Eden', 'Başlamayan'],
                    datasets: [{
                        data: [{{ tamamlanan_ezberler }}, {{ devam_eden_ezberler }}, {{ baslamayan_ezberler }}],
                        backgroundColor: [
                            'rgba(28, 200, 138, 0.7)',
                            'rgba(54, 185, 204, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // 2. Elif Ba durumu grafiği
        const elifbaDurumCtx = document.getElementById('elifbaDurumChart')?.getContext('2d');
        if (elifbaDurumCtx) {
            chartInstances.elifbaDurum = new Chart(elifbaDurumCtx, {
                type: 'pie',
                data: {
                    labels: ['Tamamlanan', 'Devam Eden', 'Başlamayan'],
                    datasets: [{
                        data: [{{ tamamlanan_elifba }}, {{ devam_eden_elifba }}, {{ baslamayan_elifba }}],
                        backgroundColor: [
                            'rgba(54, 185, 204, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // 3. Tüm sınav puanları grafiği
        const tumSinavPuanlariCtx = document.getElementById('tumSinavPuanlariChart')?.getContext('2d');
        if (tumSinavPuanlariCtx) {
            const sinavLabels = [];
            const sinavData = [];
            
            {% for sinav in sinav_sonuclari %}
                sinavLabels.push('{{ sinav.ders.get_tur_display }} - {{ sinav.get_sinav_tipi_display }}');
                sinavData.push({{ sinav.puan }});
            {% endfor %}
            
            chartInstances.tumSinavPuanlari = new Chart(tumSinavPuanlariCtx, {
                type: 'bar',
                data: {
                    labels: sinavLabels,
                    datasets: [{
                        label: 'Sınav Puanları',
                        data: sinavData,
                        backgroundColor: 'rgba(78, 115, 223, 0.7)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        
        // 7. KARŞILAŞTIRMA GRAFİKLERİ
        const ezberKarsilastirmaCtx = document.getElementById('ezberKarsilastirmaChart')?.getContext('2d');
        const elifbaKarsilastirmaCtx = document.getElementById('elifbaKarsilastirmaChart')?.getContext('2d');
        
        if (ezberKarsilastirmaCtx && elifbaKarsilastirmaCtx) {
            const labels = [];
            const ezberData = [];
            const elifbaData = [];
            
            {% for o in tum_ogrenci_verileri %}
                labels.push('{{ o.ad_soyad }}');
                ezberData.push({{ o.tamamlanan_ezber }});
                elifbaData.push({{ o.tamamlanan_elifba }});
            {% endfor %}
            
            // Mevcut öğrenci index'ini bul
            const currentStudentName = '{{ ogrenci.ad_soyad }}';
            const currentStudentIndex = labels.indexOf(currentStudentName);
            
            // Ezber karşılaştırma grafiği
            chartInstances.ezberKarsilastirma = new Chart(ezberKarsilastirmaCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tamamlanan Ezber',
                        data: ezberData,
                        backgroundColor: labels.map((label, index) => {
                            return index === currentStudentIndex ? 
                                'rgba(28, 200, 138, 1)' : 'rgba(28, 200, 138, 0.5)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Elif Ba karşılaştırma grafiği
            chartInstances.elifbaKarsilastirma = new Chart(elifbaKarsilastirmaCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tamamlanan Elif Ba',
                        data: elifbaData,
                        backgroundColor: labels.map((label, index) => {
                            return index === currentStudentIndex ? 
                                'rgba(54, 185, 204, 1)' : 'rgba(54, 185, 204, 0.5)';
                        })
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }
    
    // Sayfa yüklendiğinde grafikleri başlat
    initCharts();
});
</script>
{% endblock %}